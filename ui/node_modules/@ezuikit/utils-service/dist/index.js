/*
*
* @ezuikit/utils-service v1.0.1
* Copyright (c) 2024-3-23 Ezviz-OpenBiz
* Released under MIT the License.
*
*/
"use strict";var e=require("@ezuikit/utils-tools"),t=require("dayjs"),n="https://open.ys7.com";function o(e,t){return new Promise((function(n,o){fetch(e,t).then((function(e){return e.json()})).then((function(e){var t,i;if(200==+e.code||0==+(null==(t=e.meta)?void 0:t.code)||200==+(null==(i=e.meta)?void 0:i.code))n(e);else{if(e.meta)return e.meta.msg=e.meta.message,void o(e.meta);o(e)}})).catch((function(e){if(e.meta)return e.meta.msg=e.meta.message,void o(e.meta);o(e)}))}))}function i(e,t,n,o,i,a,r){try{var s=e[a](r),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(o,i)}function a(e,t){var n,o,i,a,r={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,o&&(i=2&a[0]?o.return:a[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;switch(o=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,o=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(i=r.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(6===a[0]&&r.label<i[1]){r.label=i[1],i=a;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(a);break}i[2]&&r.ops.pop(),r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e],o=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}function r(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var r,s=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];s.append(t,n)})),s.append("version",null!=(r=e.version)?r:"2.0"),e=s}return new Promise((function(r,s){var c=function(){return u.apply(this,arguments)},l=[];function u(){var d;return d=function(){var i,u,d,p;return a(this,(function(a){switch(a.label){case 0:return[4,o((null!=t?t:n)+"/api/lapp/video/by/time",{method:"POST",body:e})];case 1:return(u=a.sent()).data&&Array.isArray(u.data)?(l=l.concat(u.data),r({code:200,data:l,msg:""}),[2]):(!Array.isArray(u.data)&&(null==(i=u.data)?void 0:i.files)&&(l=l.concat(u.data.files),(null==(d=u.data)?void 0:d.isAll)?r({code:200,data:l,msg:""}):(null==(p=u.data)?void 0:p.nextFileTime)&&(e.append("startTime",u.data.nextFileTime),c().catch(s))),r({code:200,data:[],msg:""}),[2])}}))},u=function(){var e=this,t=arguments;return new Promise((function(n,o){var a=d.apply(e,t);function r(e){i(a,n,o,r,s,"next",e)}function s(e){i(a,n,o,r,s,"throw",e)}r(void 0)}))},u.apply(this,arguments)}c().catch(s)}))}function s(e){var t=e.slice(0,4),n=e.slice(4,6),o=e.slice(6,8),i=e.slice(8,10),a=e.slice(10,12),r=e.slice(12,14);return new Date(t+"/"+n+"/"+o+" "+i+":"+a+":"+r)}var c=function(){function i(e){if(!e)throw new Error("options is required");var t;this._options=e,/^http[s]?:\/\//.test(null!=(t=null==e?void 0:e.domain)?t:"")||(this._options.domain=n)}var a=i.prototype;return a.getDeviceCapacity=function(){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var i=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];i.append(t,n)})),e=i}return o((null!=t?t:n)+"/api/lapp/device/capacity",{method:"POST",body:e})}(e.pick(this._options,["accessToken","deviceSerial"]),this._options.domain)},a.getDeviceInfo=function(){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var i=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];i.append(t,n)})),e=i}return o((null!=t?t:n)+"/api/lapp/device/info",{method:"POST",body:e})}(e.pick(this._options,["accessToken","deviceSerial"]),this._options.domain)},a.getRealPlayUrl=function(t){var i,a,r=this,s=null==(a=this._options)||null==(i=a.extraParams)?void 0:i.ezopenParams;return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var i,a,r=new FormData;r.append("isFlv","false"),r.append("userAgent",null==(a=window)||null==(i=a.navigator)?void 0:i.userAgent),r.append("isHttp","false"),Object.entries(e).forEach((function(e){var t=e[0],n=e[1];r.append(t,n)})),e=r}return o((null!=t?t:n)+"/api/lapp/live/url/ezopen",{method:"POST",body:e})}(t=Object.assign({},e.pick(this._options,["accessToken"]),t,"object"==typeof s?s:{}),this._options.domain).then((function(e){var t,n,o,i,a,s,c,l,u,d,p="",m="",f="";if((null==e||null==(t=e.ext)?void 0:t.token)?(m+=e.data,f=e.ext.token,p=e.data):(null==(n=e.data)?void 0:n.token)&&(m+=e.data.url,f=e.data.token,p=e.data.url),m=m.includes("live")?m+"&ssn="+f+"&auth=1&biz=4&cln=100":m+"&ssn="+f+"&auth=1&cln=100",null==(i=r._options)||null==(o=i.extraParams)?void 0:o.wsParams)if("string"==typeof(null==(s=r._options)||null==(a=s.extraParams)?void 0:a.wsParams))m+="&"+(null==(d=r._options)||null==(u=d.extraParams)?void 0:u.wsParams);else if("object"==typeof(null==(l=r._options)||null==(c=l.extraParams)?void 0:c.wsParams)){var v,h;for(var b in null==(h=r._options)||null==(v=h.extraParams)?void 0:v.wsParams){var y,T;m+="&"+b+"="+(null==(T=r._options)||null==(y=T.extraParams)?void 0:y.wsParams[b])}}return{playUrl:p,stream:f,realUrl:m}}))},a.getVideoByTime=function(t){return r(t=Object.assign({},e.pick(this._options,["accessToken","deviceSerial"]),t),this._options.domain)},a.getRecordCloudVideoByTime=function(i){return function(e,i){var a,r,c={startTime:e.startTime?null==(a=t(e.startTime))?void 0:a.format("YYYY-MM-DD HH:mm:ss"):void 0,endTime:e.startTime?null==(r=t(e.endTime))?void 0:r.format("YYYY-MM-DD HH:mm:ss"):void 0,spaceId:e.spaceId},l=Object.keys(c).reduce((function(e,t){return null==c[t]?e:e+="&"+t+"="+encodeURIComponent(c[t])}),"").replace("&","");return o((null!=i?i:n)+"/api/service/cloudrecord/video/info/list?"+l,{method:"GET",headers:{accessToken:e.accessToken,deviceSerial:e.deviceSerial,localIndex:e.channelNo}}).then((function(e){return e.data=(e.data||[]).map((function(e){return e.endTime=s(e.stopTime).getTime(),e.startTime=s(e.startTime).getTime(),e.iStorageVersion=e.istorageVersion,e.busType=7,delete e.istorageVersion,e})),e}))}(i=Object.assign({},e.pick(this._options,["accessToken","deviceSerial"]),i),this._options.domain)},a.getThemeDetailById=function(e){return t={accessToken:this._options.accessToken,id:e},o((null!=(i=this._options.domain)?i:n)+"/api/service/media/template/getDetail?accessToken="+t.accessToken+"&id="+t.id,{method:"GET"});var t,i},a.setMirrorFlip=function(t){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var i=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];i.append(t,n)})),e=i}return o((null!=t?t:n)+"/api/lapp/device/ptz/mirror",{method:"POST",body:e})}(t=Object.assign({},e.pick(this._options,["accessToken","deviceSerial"]),t),this._options.domain)},a.getVideoByID=function(e){return function(e,t){if(e&&"[object FormData]"!==Object.prototype.toString.call(e)){var i=new FormData;Object.entries(e).forEach((function(e){var t=e[0],n=e[1];i.append(t,n)})),e=i}return o((null!=t?t:n)+"/api/lapp/video/by/id",{method:"POST",body:e})}(e,this._options.domain)},a.getVersion=function(){return this.version},i}();module.exports=c;
